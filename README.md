# twitter

![Node.js CI](https://github.com/tatsuya/twitter/workflows/Node.js%20CI/badge.svg)

A minimal Twitter clone, built with [Node][node] and [Redis][redis].

## Features

Currently the following features are implemented.

- Sign up and log in
- Follow and unfollow user
- Post tweet

## Data layout

### Users

User IDs are generated sequencially by [Redis's INCR](https://redis.io/commands/incr):

```js
INCR user:ids => 123
```

Each User is stored in [Redis Hashes](https://redis.io/topics/data-types). The Redis key of user is something like `user:123` and fields are:

```
name (User name)
pass (Encripted password)
fullname (User's full name)
```

Every time someone registered, this app execute the following steps.

```
INCR user:ids => 123
HMSET user:123 name "bob" pass "asdfjkl;" fullname "Bob Marley"
```

### Followers and followings

For followers and followings, [Redis's Sorted Set](https://redis.io/topics/data-types) data structure is a good fit because whenever someone start following you, or you start following someone else, that history is always sorted by insertion order (the timestamp) using the score of Sorted Set.

```
user:123:followers => Sorted Set of user IDs of all the followers users
user:123:followings => Sorted Set of user IDs of all the follwings users
```

When adding new follower:

```
ZADD user:123:followers 1401267618 456 =>> Add user 456 with time 1401267618
```

### Tweets

Tweets also have sequencial IDs, generated by [Redis's INCR](https://redis.io/commands/incr) which is same as User ID.

```js
INCR tweet:ids => 789
```

Every time someone tweets, that tweet is stored in a hash, where each key is something like `tweet:789`, with the following fields:

```
text (Body of the tweet)
created_at (Timestamp created)
user_id (User ID)
```

### Timeline

Another interesting part of this application is the Timeline. where users see all the latest updates in user's home page. Since we show those updates in chronological order, from the most recent update to the oldest, again, the Sorted Set data structure is the good fit for this use.

The app needs to create two Timelines, one is [home timeline](https://dev.twitter.com/rest/reference/get/statuses/home_timeline) where all new users will see, and the other is [user timeline](https://dev.twitter.com/rest/reference/get/statuses/user_timeline) where all updates are customized per user.

```
user:123:user_timeline => Sorted Set of tweet IDs posted by the user
user:123:home_timeline => Sorted Set of tweet IDs posted by the user and the users they follow
```

For example, retrieving latest 5 tweet IDs from the user timeline is:

```
ZREVRANGE user:123:home_timeline 0 4
```

## Development

### Download project

Clone this repository and `cd` to the project directory, run:

```
$ npm install
```

This will install all required dependencies.

### Install Docker

This project uses [Express][express] as a web application framework. The Express app is containerized with [Docker][docker] enabling you to run the Node.js application and Redis in containers.

To build and run the Node.js application, you can use [Docker Compose][docker-compose] commands. Docker Compose is a tool for defining and running multi-container Docker applications.

From the project directory, start up the application by running:

```
docker-compose up
```

Docker Compose pulls a [Redis image](https://hub.docker.com/_/redis/), builds an image for the application code, and starts the services defined in `docker-compose.yml` file.

Enter `http://localhost:49160/` in a browser to see the application running.

## Deployment

For deployment, `Procfile` is packaged as a default configuration to integrate with Heroku. If you are not familiar with Heroku I would recommend you to first read through the documentation of [how to get started with Node.js on Heroku][heroku-getting-started-with-node].

The whole deployment process should be as simple as the follwing 3 steps.

Login to Heroku:

```
$ heroku login
````

Create an app on Heroku:

```
$ heroku create
```

Deploy an app:

```
$ git push heroku master
```

## References

- [antirez/retwis][retwis] - A Twitter-toy clone written in PHP and Redis
- [twissandra/twissandra][twissandra] - Twissandra is an example project, created to learn and demonstrate how to use Cassandra.

## License

MIT Â© Tatsuya Oiwa

[node]: https://nodejs.org/
[redis]: http://redis.io/
[docker]: https://www.docker.com/
[docker-compose]: https://docs.docker.com/compose/
[express]: http://expressjs.com/
[heroku-getting-started-with-node]: https://devcenter.heroku.com/articles/getting-started-with-nodejs#introduction
[retwis]: https://github.com/antirez/retwis
[twissandra]: https://github.com/twissandra/twissandra
